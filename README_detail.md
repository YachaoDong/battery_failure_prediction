# 一、简介
应用于机房IDC电池故障预测，针对过去一段时间的电池数据，预测未来一段时间电池是否会发生故障。
主要使用两种方法去做，一种是基于深度学习LSTM模型，即将问题看作为基于时间序列预测的问题；另外一种是基于机器学习方法，对数据进行分析、自动标注、特征工程、分类进行预测。
# 二、基于深度学习——LSTM
## 0.思路
将问题看作是基于多维特征的时间序列预测问题，即先预测未来的数值，然后根据业务判断逻辑对未来预测的数值进行判断是否为故障点。
多维变量选取：电池单体电压、内阻、温度、电池组电压。
## 1.数据处理
- **数据标注：** 自动数据标注，如[x1,...xt],  训练集为[x1, x2, x3, x4, x5], 对应的label为[x6, x7, x8,...]， label的长度取决于预测未来的时间窗口，这一部分值用于后续回归值预测训练的监督。另外一方面对这些labels转为为分类标签（0，1即是否故障），用于分类监督训练。
- **数据处理：** 标准化（如果使用归一化，对于未来数据处理后可能不在0~1范围内）、训练集测试集划分、dataloader

## 2.模型
- **使用模型：** RNN, LSTM, tpaLSTM(增加了注意力等)
- **模型输出修改：** 由于是多变量输入，需要预测多变量输出，并且需要输出预测窗口值的长度，所以输出维度为(bs, 预测窗口长度，多维变量维度)，所以在LSTM输出后面增加了conv层，能输出两个维度的变量。

## 3.loss
- **回归loss：** Mean Square Error Loss, L1 loss, etc.
- **分类loss：** BCEWithLogitsLoss

## 4.评估方法
常用的分类评估指标，P, R, mAP，但是是根据实际业务场景自定义修改，
## 5.结果
使用M6机房电池数据进行训练测试，不同时间段的电池样本数训练集为1222，测试集为314，
      按照60天数据进行训练，并对未来10天的数据进行预测，可分割出训练集总量为366600，测试集数量为94200
模型结果如下：
eval_loss: 0.1152, 
	eval_cls_loss: 0.2798,  
Recall：78.48， F1: 77.21， Precision：87.61， accuracy：71.69
## 6. 总结
**关键点：**
1. 数据集的采集，分析，处理，标注。包括异常缺失数据处理。 
2. 动态阈值进行标注，就前前后两个点的斜率差，找出最大斜率差的两对数据定义为拐点（新阈值）。
3. lstm输出两个维度的变化值的改写。


# 三、基于机器学习方法
# 0. 思路
将其看做是一个分类问题，根据业务知识和数据分析对其进行自动标注，大致原理为将故障阈值，往前推一个月的时间点记为change point；将当前电压值往前推一段时间（2个月，计算区间为一个月）计算标准差，大于某个值记为change point，所以预测的时间窗口有往前推得时间确定，但不保证预测的时间点一定是往前推的时间，平均下来预测的时间为15天至一个月。

- **业务知识：** 选取浮充状态下的电池数据；数据颗粒度为5分钟；数据故障分为自然老化（内阻达到5mΩ）和内部故障（电压下降并剧烈波动）
 
## 1. 数据处理
- **数据特征维度：** time_stamp, 电池单体电压，电池单体内阻，电池单体温度，电池组电压，电池组内阻
- **数据清洗：** 缺失值删除或者使用前后值填充。
- **数据自动标注：** 
**自然老化：** changepoint = 电池内阻达到5mΩ往前推一个月的时间点；
**内部故障：** 故障初期电池的浮充电压会下降并剧烈波动。
首先计算当前浮充电压Vt 往前推 前两个月——前一个月的均值电压(Vt-2M : Vt-M)的中位数电压Vm；
其次找到当前Vt往前推一周的时间(这个时间应该是控制预测未来时间的窗口值) Vt-W，然后求这一周每一分钟的电压值与中位电压的标准差，然后乘以权重因子Wi；
最终得到每个时间点的标准差Dt，再计算一个所有正常电压样本的经验标准差sigma，取Dt >= 3*sigma的最小t值，即最早的changepoint。

- **类别不平衡问题：** 使用欠采样方法，将正常电池样本聚类k个簇，然后选择离各个簇中心最近的n个数据样本做代表。K=50， n=1000。
## 2. 模型
- **特征工程：** 
（1）基础特征：
电流、电压、内阻、温度。浮充电流始终为0，所以只使用电压Vt、内阻Rt、温度Tt，t代表当前时间点的值。
（2）电池组相关特征：
因为单个电池的状态会影响电池组的状态，所以期望使用电池组属性揭示出其包含的单个电池的潜在故障。电池组电压的平均值和经验标准差。
相对电压 RVt = Vt - 该电池组的均值电压
相对内阻 RRt = Rt - 该电池组的均值内阻
（3）时间序列特征：
电压电阻变化率 VCt = Vt - Mean[ V(t-Tc) : (T-Tc+D) ], Tc为  
（4）组合特征：
VDRt = Vt / Rt
- **模型：** 决策树，GBDT， lightGBM ， 调参 + 3-折交叉验证，学习率：0.05，boosting stages 设为300

## 3. 结果
Before undersampling....
Train set: (13477079, 8)
Train 1 set: (1876177, 8)
Train 0 set: (11600902, 8)
Start undersampling.....
undersampling cost time:  3.0136609077453613
After undersampling....
Train 0 set: (8000000, 8)
Final train set: (9876177, 8)
Training cost time: 1575.9997389316559

	results:                  precision    recall     f1-score               support

           0                   0.97           0.99            0.98            2900525
           1                   0.96           0.83            0.89           468745
    accuracy                                                  0.97           3369270
    macro avg                  0.97           0.91            0.94            3369270
    weighted avg               0.97           0.97            0.97           3369270

## 6. 总结
- **关键点：** 数据分析，业务知识理解，数据自动标注，样本不平衡，特征工程，调参。